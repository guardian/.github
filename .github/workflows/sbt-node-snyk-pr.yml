name: Simple Snyk test for SBT + Node

on:
  workflow_call:
    inputs:
      SKIP_NODE:
        type: boolean
        required: false
        default: false
      SKIP_SBT:
        type: boolean
        required: false
        default: false
      DEBUG:
        type: string
        required: false
      SEVERITY_THRESHOLD:
        type: string
        required: false
      ORG:
        type: string
        required: true
      EXCLUDE:
        type: string
        required: false
        default: ""
      JAVA_VERSION:
        type: string
        required: false
        default: "11"
      NODE_VERSION_FILE:
        type: string
        required: false
        default: ".nvmrc"
      PRUNE_DUPLICATES:
        type: boolean
        required: false
        default: false
    secrets:
      SNYK_TOKEN:
        required: true

jobs:
    security:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout branch
              uses: actions/checkout@v2

            - uses: snyk/actions/setup@0.3.0
            - uses: actions/setup-node@v2
              if: inputs.SKIP_NODE != true
              with:
                  node-version-file: ${{ inputs.NODE_VERSION_FILE }}

            - uses: actions/setup-java@v2
              if: inputs.SKIP_SBT != true
              with:
                  java-version: ${{ inputs.JAVA_VERSION }}
                  distribution: "adopt"

            - name: Snyk test
              run: snyk test ${INPUT_DEBUG:+ -d} ${PRUNE_DUPLICATES:+ -p} --severity-threshold=${SEVERITY_THRESHOLD:-high} --all-projects --org="${{ inputs.ORG }}"  --exclude="${{ inputs.EXCLUDE }}"
              env:
                  INPUT_DEBUG: ${{ inputs.DEBUG }}
                  SEVERITY_THRESHOLD: ${{ inputs.SEVERITY_THRESHOLD }}
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
                  PRUNE_DUPLICATES: ${{ secrets.PRUNE_DUPLICATES }}
