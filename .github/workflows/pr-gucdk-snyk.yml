name: Snyk Infrastructure as code test for projects using GuCDK. Intended as a blocking PR check

on:
  workflow_call:
    inputs:
      PACKAGE_MANAGER:
        type: string
        description: 'The package manager used in the project. Valid values are: npm, yarn'
        required: false
        default: 'npm'
      CDK_ROOT:
        type: string
        description: 'The root directory of the CDK project'
        required: false
        default: 'cdk/'
      NODE_VERSION_FILE:
        type: string
        required: false
        default: ".nvmrc"
      SEVERITY_THRESHOLD:
        type: string
        required: false
        description: 'Severity threshold for failing the build. Valid values are: low, medium, high, critical'
        default: 'high'
    secrets:
      SNYK_TOKEN:
        required: true

jobs:
    security:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout branch
              uses: actions/checkout@v3

            - uses: snyk/actions/setup@0.3.0

            - uses: actions/setup-node@v2
              with:
                  node-version-file: ${{ inputs.NODE_VERSION_FILE }}

            - name: Snyk Infrastructure as Code test
              run: |
                set -e
                cd ${{ inputs.CDK_ROOT }}
                echo $SYNTH | bash
                snyk iac test cdk.out/*.template.json \
                --severity-threshold=${{inputs.SEVERITY_THRESHOLD}} \

              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
                  SYNTH: ${{ inputs.PACKAGE_MANAGER == 'npm' && 'npm ci && npm run synth -- --quiet' || 'yarn install --frozen-lockfile && yarn synth' }}