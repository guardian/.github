name: Release .github

on:
  push: 
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - '.github/workflow-templates/**'
      - '!.github/workflows/release.yaml'
      - '!**/*.md'

permissions: {}

jobs:
  release:
    runs-on: ubuntu-slim
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: version
        run: |
          set -euo pipefail

          LATEST_TAG=$(git describe --tags --abbrev=0)
          echo "Latest tag: $LATEST_TAG"

          # Extract version into major, minor, patch numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Validate tag format - fail if malformed
          if ! [[ "$MAJOR" =~ ^[0-9]+$ ]] || ! [[ "$MINOR" =~ ^[0-9]+$ ]] || ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
            echo "Error: Latest tag '$LATEST_TAG' is not in valid semver format (v#.#.#)"
            echo "Expected format: v1.2.3 (where each component is a number)"
            exit 1
          fi

          # Check commit messages for hints to version (major, minor, patch)
          COMMITS=$(git log "$LATEST_TAG"..HEAD --pretty=format:"%s")

          if echo "$COMMITS" | grep -qiE "(\!:|breaking|major)"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif echo "$COMMITS" | grep -qiE "^(feat|feature)|^Bump:"; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "New version: $NEW_VERSION"
      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.new_version }}" \
            --title "${{ steps.version.outputs.new_version }}" \
            --generate-notes \
            --latest